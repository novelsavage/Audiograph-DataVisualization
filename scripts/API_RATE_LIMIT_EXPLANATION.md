# Spotify API レートリミットの説明

## 「1リクエスト」とは？

**1リクエスト = Spotify APIへの1回のHTTP呼び出し**

Pythonスクリプト内で以下のような関数を呼び出すと、それぞれが1リクエストとしてカウントされます：

- `sp.search()` → 1リクエスト
- `sp.artist_albums()` → 1リクエスト
- `sp.album_tracks()` → 1リクエスト
- `sp.tracks()` → 1リクエスト（複数のトラックIDを渡しても1リクエスト）

## スクリプト内でのリクエスト数の計算

### 1. アーティスト検索フェーズ

```python
# 4つのジャンル × 1リクエスト = 4リクエスト
for genre in ["j-pop", "j-rock", "j-idol", "anime"]:
    results = sp.search(...)  # 1リクエスト
    time.sleep(0.3)
```

**合計: 約4リクエスト**

### 2. フィーチャリング探索フェーズ（オプション）

```python
# 各アーティストに対して:
for artist in artists:  # 最大400アーティスト（200 × 2）
    tracks = get_artist_tracks(artist_id, limit=30)
    # この中で:
    # - sp.artist_albums() → 1リクエスト
    # - sp.album_tracks() → 平均3-5リクエスト（アルバム数による）
    # - sp.tracks() → 1リクエスト（バッチ処理で50曲ずつ）
```

**1アーティストあたり: 約5-7リクエスト**
**400アーティスト: 約2,000-2,800リクエスト**

### 3. ネットワーク構築フェーズ

```python
# 各アーティストに対して:
for artist in artists:  # 最大200アーティスト
    tracks = get_artist_tracks(artist_id, limit=30)
    # 同様に5-7リクエスト/アーティスト
```

**200アーティスト: 約1,000-1,400リクエスト**

## 合計リクエスト数の見積もり

### フィルタリングありの場合
- 検索: 4リクエスト
- フィルタリング: 2,000-2,800リクエスト
- ネットワーク構築: 1,000-1,400リクエスト
- **合計: 約3,000-4,200リクエスト**

### フィルタリングなしの場合
- 検索: 4リクエスト
- ネットワーク構築: 1,000-1,400リクエスト
- **合計: 約1,000-1,400リクエスト**

## 処理時間の見積もり

### 現在の設定（0.3秒/リクエスト）

- **フィルタリングあり**: 3,000-4,200リクエスト × 0.3秒 = **15-21分**
- **フィルタリングなし**: 1,000-1,400リクエスト × 0.3秒 = **5-7分**

### より安全な設定（0.5秒/リクエスト）

- **フィルタリングあり**: 3,000-4,200リクエスト × 0.5秒 = **25-35分**
- **フィルタリングなし**: 1,000-1,400リクエスト × 0.5秒 = **8-12分**

## Spotify APIのレート制限

Spotify APIの公式なレート制限は公開されていませんが、一般的に：

- **Client Credentials Flow（このスクリプトで使用）**: 1秒あたり数リクエスト
- **推奨**: 1秒あたり2-3リクエストが安全

### レート制限エラー（429）が発生した場合

スクリプトは自動的に：
1. エラーを検出
2. `Retry-After`ヘッダーから待機時間を取得
3. 指定された時間待機
4. リトライ

## 最適化のヒント

### リクエスト数を減らす方法

1. **バッチ処理の活用**
   - `sp.tracks()`は最大50曲まで1リクエストで取得可能
   - 現在のスクリプトは既にこれを実装しています

2. **不要なAPI呼び出しを削減**
   - フィルタリング機能を使用して、フィーチャリングがあるアーティストのみを処理

3. **取得する楽曲数を調整**
   - `MIN_TRACKS_PER_ARTIST`を減らすとリクエスト数が減ります
   - ただし、エッジ数も減る可能性があります

### 処理時間を短縮する方法

1. **並列処理**（注意が必要）
   - 複数のアーティストを並列に処理
   - ただし、レート制限に注意

2. **待機時間の調整**
   - `REQUEST_DELAY`を0.2秒に減らす（リスクあり）
   - レート制限エラーが頻発する場合は増やす

3. **処理するアーティスト数を減らす**
   - `MAX_ARTISTS_TO_PROCESS`を減らす

## 実際の使用例

### 小規模なテスト（50アーティスト）

```python
MAX_ARTISTS_TO_PROCESS = 50
MIN_TRACKS_PER_ARTIST = 20
FILTER_BY_FEATURINGS = False
```

**リクエスト数**: 約250-350リクエスト
**処理時間**: 約1-2分

### 中規模（100アーティスト）

```python
MAX_ARTISTS_TO_PROCESS = 100
MIN_TRACKS_PER_ARTIST = 30
FILTER_BY_FEATURINGS = True
```

**リクエスト数**: 約1,500-2,100リクエスト
**処理時間**: 約8-11分

### 大規模（200アーティスト）

```python
MAX_ARTISTS_TO_PROCESS = 200
MIN_TRACKS_PER_ARTIST = 30
FILTER_BY_FEATURINGS = True
```

**リクエスト数**: 約3,000-4,200リクエスト
**処理時間**: 約15-21分

